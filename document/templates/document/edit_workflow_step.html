{% extends "_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<style>
  /* Custom Dropdown Styles - Inline for immediate application */
  .workflow-select-btn { background-color: white; border-color: #e5e7eb; color: #111827; }
  .dark .workflow-select-btn { background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); color: white; }
  
  .workflow-dropdown-bg { background-color: white; border-color: #e5e7eb; }
  .dark .workflow-dropdown-bg { background-color: #1e1e1e; border-color: rgba(255, 255, 255, 0.1); }
  
  .workflow-text { color: #111827; }
  .dark .workflow-text { color: white; }
  
  .workflow-dropdown-item:hover { background-color: #f3f4f6; }
  .dark .workflow-dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); }
</style>
<!-- Hero Section -->
<div class="relative z-10 mb-10">
    <h1 class="relative mb-3 text-4xl font-bold tracking-tight text-gray-900 md:text-5xl dark:text-white">
        Edit <br>
        <span class="text-transparent bg-clip-text bg-gradient-to-r to-fuchsia-500 from-neon-violet text-glow">Workflow Step</span>
    </h1>
    <p class="max-w-2xl text-lg text-gray-600 dark:text-gray-400">
        Modify step settings for workflow: <span class="font-medium text-neon-violet">{{ workflow.name }}</span>
    </p>
    <!-- Background Glow -->
    <div class="absolute -top-20 -left-20 w-96 h-96 bg-neon-violet/20 blur-[100px] rounded-full -z-10 pointer-events-none"></div>
</div>

<div class="container relative z-10 mx-auto">
  <div class="p-8 rounded-2xl border border-gray-200 shadow-xl glass-card md:p-10 dark:border-white/10">
    
    <!-- Alpine.js Form -->
    <div x-data="{
      name: '{{ step.name|escapejs }}',
      order: '{{ step.order }}',
      approvalMode: '{{ step.approval_mode }}',
      requiresEdit: {{ step.requires_edit|lower }},
      
      // Approvers
      approverType: '{{ approver_type }}',
      selectedApprovers: {{ selected_approvers|safe }},
      approverGroups: {{ selected_approver_groups|safe }},
      allowCustomApprover: {% if step.allow_custom_approver %}true{% else %}false{% endif %},
      
      // Search & Filter State
      approverSearch: '',
      groupSearch: '',
      showSelectedApproversOnly: false,
      showSelectedGroupsOnly: false,
      
      // Conditional Logic
      isConditional: {{ step.is_conditional|lower }},
      moveToNext: {{ step.move_to_next|lower }},
      conditionField: '{{ step.condition_field.id|default:'' }}',
      conditionOperator: '{{ step.condition_operator|default:'eq' }}',
      conditionValue: '{{ step.condition_value|default:''|escapejs }}',
      
      // Lookups for Custom Selects
      fieldMap: {
        {% for field in dynamic_fields %}
        {{ field.id }}: '{{ field.name|escapejs }}'{% if not forloop.last %}, {% endif %}
        {% endfor %}
      },
      operatorMap: {
        {% for op_value, op_display in condition_operators %}
        '{{ op_value }}': '{{ op_display|escapejs }}'{% if not forloop.last %}, {% endif %}
        {% endfor %}
      },
      
      // Validation
      errors: {},
      
      validateForm() {
        this.errors = {};
        
        if (!this.name) this.errors.name = 'Name is required';
        if (!this.order) this.errors.order = 'Order is required';
        
        if (this.approverType === 'specific' && this.selectedApprovers.length === 0) {
          this.errors.approvers = 'Please select at least one approver';
        }
        
        if (this.approverType === 'group' && this.approverGroups.length === 0) {
          this.errors.approverGroups = 'Please select at least one approver group';
        }
        
        if (this.isConditional) {
          if (!this.conditionField) this.errors.conditionField = 'Condition field is required';
          if (!this.conditionValue) this.errors.conditionValue = 'Condition value is required';
        }
        
        return Object.keys(this.errors).length === 0;
      }
    }" class="space-y-8">
      <form method="POST" action="" @submit.prevent="if(validateForm()) $el.submit()">
        {% csrf_token %}
        
        <!-- Basic Information Section -->
        <div class="p-6 rounded-xl border border-gray-200 bg-gray-50/50 dark:bg-white/5 dark:border-white/10">
          <h2 class="flex gap-2 items-center mb-6 text-lg font-bold text-gray-900 dark:text-white">
            <div class="p-2 text-blue-500 rounded-lg border bg-blue-500/10 dark:text-blue-400 border-blue-500/20">
              <i data-lucide="info" class="w-5 h-5"></i>
            </div>
            Basic Information
          </h2>
          
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <!-- Step Name -->
            <div>
              <label for="name" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Step Name</label>
              <input type="text" name="name" id="name" x-model="name" 
                     class="px-4 py-2.5 w-full placeholder-gray-400 text-gray-900 bg-white rounded-lg border border-gray-200 dark:bg-white/5 dark:border-white/10 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent dark:placeholder-gray-600"
                     :class="{'border-red-500': errors.name}">
              <p x-show="errors.name" x-text="errors.name" class="mt-1 text-sm text-red-500"></p>
            </div>
            
            <!-- Step Order -->
            <div>
              <label for="order" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Order</label>
              <input type="number" name="order" id="order" x-model="order" min="1"
                     class="px-4 py-2.5 w-full text-gray-900 bg-white rounded-lg border border-gray-200 dark:bg-white/5 dark:border-white/10 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                     :class="{'border-red-500': errors.order}">
              <p x-show="errors.order" x-text="errors.order" class="mt-1 text-sm text-red-500"></p>
            </div>
          </div>
          
          <div class="mt-6">
            <!-- Approval Mode -->
            <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Approval Mode</label>
            <div class="flex flex-wrap gap-4">
              <label class="inline-flex items-center p-3 rounded-lg border border-gray-200 transition-colors cursor-pointer dark:border-white/10 hover:border-neon-violet/50" :class="{'bg-neon-violet/5 border-neon-violet/50': approvalMode === 'all'}">
                <input type="radio" name="approval_mode" value="all" x-model="approvalMode" class="w-4 h-4 bg-transparent border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">All Approvers Required</span>
              </label>
              <label class="inline-flex items-center p-3 rounded-lg border border-gray-200 transition-colors cursor-pointer dark:border-white/10 hover:border-neon-violet/50" :class="{'bg-neon-violet/5 border-neon-violet/50': approvalMode === 'any'}">
                <input type="radio" name="approval_mode" value="any" x-model="approvalMode" class="w-4 h-4 bg-transparent border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Any Approver Sufficient</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Approvers Section -->
        <div class="p-6 rounded-xl border border-gray-200 bg-gray-50/50 dark:bg-white/5 dark:border-white/10">
          <h2 class="flex gap-2 items-center mb-6 text-lg font-bold text-gray-900 dark:text-white">
            <div class="p-2 text-purple-500 rounded-lg border bg-purple-500/10 dark:text-purple-400 border-purple-500/20">
              <i data-lucide="users" class="w-5 h-5"></i>
            </div>
            Approvers
          </h2>
          
          <div class="flex items-center p-4 mb-6 bg-white rounded-lg border border-gray-200 dark:bg-white/5 dark:border-white/10">
            <input id="allow_custom_approver" name="allow_custom_approver" type="checkbox" 
                   :checked="allowCustomApprover"
                   @change="allowCustomApprover = $event.target.checked"
                   class="w-5 h-5 bg-transparent rounded border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
            <input type="hidden" name="allow_custom_approver_value" :value="allowCustomApprover ? 'on' : 'off'">
            <label for="allow_custom_approver" class="ml-3 text-sm font-medium text-gray-900 cursor-pointer select-none dark:text-white">
              Allow Custom Approver selection during workflow
            </label>
          </div>

          <div class="mb-6">
            <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Approver Type</label>
            <div class="flex flex-wrap gap-4">
              <label class="inline-flex items-center cursor-pointer">
                <input type="radio" name="approverType" value="specific" x-model="approverType" class="w-4 h-4 bg-transparent border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Specific Users</span>
              </label>
              <label class="inline-flex items-center cursor-pointer" x-show="allowCustomApprover">
                <input type="radio" name="approverType" value="group" x-model="approverType" class="w-4 h-4 bg-transparent border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">User Group</span>
              </label>
              <label class="inline-flex items-center cursor-pointer">
                <input type="radio" name="approverType" value="submitter" x-model="approverType" class="w-4 h-4 bg-transparent border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Submitter</span>
              </label>
            </div>
          </div>
          
          <!-- Specific Approvers -->
          <div x-show="approverType === 'specific'" class="mb-4">
            <div class="flex justify-between items-center mb-2">
                <label class="text-sm font-bold text-gray-700 dark:text-gray-300">Select Approvers</label>
                <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-neon-violet/10 text-neon-violet" 
                      x-show="selectedApprovers.length > 0" 
                      x-text="selectedApprovers.length + ' selected'"
                      x-transition></span>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="flex gap-2 mb-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 w-4 h-4 text-gray-400 transform -translate-y-1/2"></i>
                    <input type="text" x-model="approverSearch" placeholder="Search users..." 
                           class="py-1.5 pr-3 pl-9 w-full text-sm placeholder-gray-400 text-gray-900 bg-white rounded-lg border border-gray-200 dark:border-white/10 dark:bg-white/5 focus:ring-2 focus:ring-neon-violet focus:border-transparent dark:text-white dark:placeholder-gray-500">
                </div>
                <button type="button" 
                        @click="showSelectedApproversOnly = !showSelectedApproversOnly"
                        class="flex gap-1 items-center px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors"
                        :class="showSelectedApproversOnly ? 'bg-neon-violet/10 border-neon-violet/30 text-neon-violet' : 'bg-white dark:bg-white/5 border-gray-200 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/10'">
                    <i data-lucide="filter" class="w-3 h-3"></i>
                    Selected Only
                </button>
            </div>

            <div class="overflow-y-auto p-2 space-y-1 max-h-60 bg-white rounded-xl border border-gray-200 dark:border-white/10 dark:bg-white/5 custom-scrollbar"
                 :class="{'border-red-500': errors.approvers}">
              {% for user in users %}
              <label class="flex items-center p-2 rounded-lg border transition-all duration-200 cursor-pointer group"
                     x-show="(approverSearch === '' || '{{ user.get_full_name|default:user.username|escapejs }}'.toLowerCase().includes(approverSearch.toLowerCase())) && (!showSelectedApproversOnly || selectedApprovers.includes('{{ user.id }}'))"
                     :class="selectedApprovers.includes('{{ user.id }}') ? 'bg-neon-violet/5 border-neon-violet/30 dark:bg-neon-violet/10' : 'bg-transparent border-transparent hover:bg-gray-50 dark:hover:bg-white/5'">
                <div class="flex relative items-center">
                    <input type="checkbox" name="approvers[]" value="{{ user.id }}" 
                           x-model="selectedApprovers" 
                           class="w-4 h-4 bg-transparent rounded border-gray-300 transition-transform duration-200 text-neon-violet dark:border-white/20 focus:ring-neon-violet"
                           :class="selectedApprovers.includes('{{ user.id }}') ? 'scale-110' : ''">
                </div>
                <span class="flex-1 ml-3 text-sm transition-colors"
                      :class="selectedApprovers.includes('{{ user.id }}') ? 'text-neon-violet font-medium' : 'text-gray-700 dark:text-gray-200 group-hover:text-neon-violet'">
                    {{ user.get_full_name|default:user.username }}
                </span>
                <i data-lucide="check" class="w-4 h-4 opacity-0 transition-opacity duration-200 text-neon-violet"
                   :class="selectedApprovers.includes('{{ user.id }}') ? 'opacity-100' : 'opacity-0'"></i>
              </label>
              {% endfor %}
              
            </div>
            <p x-show="errors.approvers" x-text="errors.approvers" class="mt-1 text-sm text-red-500"></p>
          </div>
          
          <!-- Approver Groups (Multiple Selection) -->
          <div x-show="approverType === 'group'" class="mb-4">
            <div class="flex justify-between items-center mb-2">
                <label class="text-sm font-bold text-gray-700 dark:text-gray-300">Select Groups</label>
                <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-neon-violet/10 text-neon-violet" 
                      x-show="approverGroups.length > 0" 
                      x-text="approverGroups.length + ' selected'"
                      x-transition></span>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="flex gap-2 mb-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 w-4 h-4 text-gray-400 transform -translate-y-1/2"></i>
                    <input type="text" x-model="groupSearch" placeholder="Search groups..." 
                           class="py-1.5 pr-3 pl-9 w-full text-sm placeholder-gray-400 text-gray-900 bg-white rounded-lg border border-gray-200 dark:border-white/10 dark:bg-white/5 focus:ring-2 focus:ring-neon-violet focus:border-transparent dark:text-white dark:placeholder-gray-500">
                </div>
                <button type="button" 
                        @click="showSelectedGroupsOnly = !showSelectedGroupsOnly"
                        class="flex gap-1 items-center px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors"
                        :class="showSelectedGroupsOnly ? 'bg-neon-violet/10 border-neon-violet/30 text-neon-violet' : 'bg-white dark:bg-white/5 border-gray-200 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-white/10'">
                    <i data-lucide="filter" class="w-3 h-3"></i>
                    Selected Only
                </button>
            </div>

            <div class="overflow-y-auto p-2 space-y-1 max-h-60 bg-white rounded-xl border border-gray-200 dark:border-white/10 dark:bg-white/5 custom-scrollbar"
                 :class="{'border-red-500': errors.approverGroups}">
              {% for group in groups %}
              <label class="flex items-center p-2 rounded-lg border transition-all duration-200 cursor-pointer group"
                     x-show="(groupSearch === '' || '{{ group.name|escapejs }}'.toLowerCase().includes(groupSearch.toLowerCase())) && (!showSelectedGroupsOnly || approverGroups.includes('{{ group.id }}'))"
                     :class="approverGroups.includes('{{ group.id }}') ? 'bg-neon-violet/5 border-neon-violet/30 dark:bg-neon-violet/10' : 'bg-transparent border-transparent hover:bg-gray-50 dark:hover:bg-white/5'">
                <div class="flex relative items-center">
                    <input type="checkbox" name="approver_groups[]" value="{{ group.id }}" 
                           x-model="approverGroups" 
                           class="w-4 h-4 bg-transparent rounded border-gray-300 transition-transform duration-200 text-neon-violet dark:border-white/20 focus:ring-neon-violet"
                           :class="approverGroups.includes('{{ group.id }}') ? 'scale-110' : ''">
                </div>
                <span class="flex-1 ml-3 text-sm transition-colors"
                      :class="approverGroups.includes('{{ group.id }}') ? 'text-neon-violet font-medium' : 'text-gray-700 dark:text-gray-200 group-hover:text-neon-violet'">
                    {{ group.name }}
                </span>
                <i data-lucide="check" class="w-4 h-4 opacity-0 transition-opacity duration-200 text-neon-violet"
                   :class="approverGroups.includes('{{ group.id }}') ? 'opacity-100' : 'opacity-0'"></i>
              </label>
              {% endfor %}
              
            </div>
            <p x-show="errors.approverGroups" x-text="errors.approverGroups" class="mt-1 text-sm text-red-500"></p>
          </div>
        </div>
        
        <!-- Conditional Logic Section -->
        <div class="p-6 rounded-xl border border-gray-200 bg-gray-50/50 dark:bg-white/5 dark:border-white/10">
          <div class="flex justify-between items-center mb-6">
            <h2 class="flex gap-2 items-center text-lg font-bold text-gray-900 dark:text-white">
              <div class="p-2 text-teal-500 rounded-lg border bg-teal-500/10 dark:text-teal-400 border-teal-500/20">
                <i data-lucide="git-branch" class="w-5 h-5"></i>
              </div>
              Conditional Logic
            </h2>
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="isConditional" class="w-5 h-5 bg-transparent rounded border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
              <span class="ml-2 text-sm font-medium text-gray-700 select-none dark:text-gray-300">Enable Conditional Logic</span>
            </label>
            <input type="hidden" :value="isConditional ? 'true' : 'false'" name="is_conditional">
          </div>
          
          <div x-show="isConditional" class="space-y-4" x-transition>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
              <!-- Condition Field -->
              <div>
                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Field</label>
                <div class="relative" x-data="{ open: false }" @click.away="open = false">
                  <button type="button" @click="open = !open"
                          class="flex relative justify-between items-center px-4 py-2.5 w-full text-left rounded-lg border workflow-select-btn focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                          :class="{'border-red-500': errors.conditionField}">
                    <span x-text="conditionField ? fieldMap[conditionField] : '-- Select Field --'"></span>
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  </button>
                  
                  <div x-show="open" x-transition class="overflow-auto absolute z-50 mt-1 w-full max-h-60 rounded-lg border shadow-lg workflow-dropdown-bg">
                    {% for field in dynamic_fields %}
                    <div @click="conditionField = '{{ field.id }}'; open = false"
                         class="px-4 py-2 cursor-pointer workflow-dropdown-item workflow-text">
                      {{ field.name }}
                    </div>
                    {% endfor %}
                  </div>
                  <select name="condition_field" x-model="conditionField" class="hidden">
                    <option value="">-- Select Field --</option>
                    {% for field in dynamic_fields %}
                    <option value="{{ field.id }}">{{ field.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <p x-show="errors.conditionField" x-text="errors.conditionField" class="mt-1 text-sm text-red-500"></p>
              </div>
              
              <!-- Condition Operator -->
              <div>
                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Operator</label>
                <div class="relative" x-data="{ open: false }" @click.away="open = false">
                  <button type="button" @click="open = !open"
                          class="flex relative justify-between items-center px-4 py-2.5 w-full text-left rounded-lg border workflow-select-btn focus:ring-2 focus:ring-neon-violet focus:border-transparent">
                    <span x-text="operatorMap[conditionOperator] || conditionOperator"></span>
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  </button>
                  
                  <div x-show="open" x-transition class="overflow-auto absolute z-50 mt-1 w-full max-h-60 rounded-lg border shadow-lg workflow-dropdown-bg">
                    {% for op_value, op_display in condition_operators %}
                    <div @click="conditionOperator = '{{ op_value }}'; open = false"
                         class="px-4 py-2 cursor-pointer workflow-dropdown-item workflow-text">
                      {{ op_display }}
                    </div>
                    {% endfor %}
                  </div>
                  <select name="condition_operator" x-model="conditionOperator" class="hidden">
                    {% for op_value, op_display in condition_operators %}
                    <option value="{{ op_value }}">{{ op_display }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              
              <!-- Condition Value -->
              <div>
                <label for="condition_value" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Value</label>
                <input type="text" name="condition_value" id="condition_value" x-model="conditionValue"
                       class="px-4 py-2.5 w-full text-gray-900 bg-white rounded-lg border border-gray-200 dark:bg-white/5 dark:border-white/10 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                       :class="{'border-red-500': errors.conditionValue}">
                <p x-show="errors.conditionValue" x-text="errors.conditionValue" class="mt-1 text-sm text-red-500"></p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Workflow Flow Control Section -->
        <div class="p-6 rounded-xl border border-gray-200 bg-gray-50/50 dark:bg-white/5 dark:border-white/10">
          <h2 class="flex gap-2 items-center mb-4 text-lg font-bold text-gray-900 dark:text-white">
            <div class="p-2 text-orange-500 rounded-lg border bg-orange-500/10 dark:text-orange-400 border-orange-500/20">
              <i data-lucide="arrow-right-circle" class="w-5 h-5"></i>
            </div>
            Workflow Flow Control
          </h2>
          
          <!-- Move to Next Step -->
          <div class="flex items-center">
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="moveToNext" class="w-5 h-5 bg-transparent rounded border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
              <span class="ml-3 text-sm font-medium text-gray-700 select-none dark:text-gray-300">Move to next step after this step</span>
            </label>
          </div>
          <p class="mt-2 ml-8 text-xs text-gray-500 dark:text-gray-400">If unchecked, workflow will complete after this step (when condition is met for conditional steps)</p>
          <input type="hidden" :value="moveToNext ? 'true' : 'false'" name="move_to_next">
        </div>
        
        <!-- Editable Fields Section -->
        <div class="p-6 rounded-xl border border-gray-200 bg-gray-50/50 dark:bg-white/5 dark:border-white/10">
          <div class="flex justify-between items-center mb-4">
            <h2 class="flex gap-2 items-center text-lg font-bold text-gray-900 dark:text-white">
              <div class="p-2 text-indigo-500 rounded-lg border bg-indigo-500/10 dark:text-indigo-400 border-indigo-500/20">
                <i data-lucide="edit-3" class="w-5 h-5"></i>
              </div>
              Editable Fields
            </h2>
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="requiresEdit" class="w-5 h-5 bg-transparent rounded border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
              <input type="hidden" name="requires_edit" :value="requiresEdit ? 'true' : 'false'">
              <span class="ml-2 text-sm font-medium text-gray-700 select-none dark:text-gray-300">Requires Edit</span>
            </label>
          </div>
          
          <div x-show="requiresEdit" class="space-y-4" x-transition>
            <p class="mb-3 text-sm text-gray-600 dark:text-gray-400">Select which fields can be edited by approvers at this step:</p>
            
            <div class="overflow-y-auto p-4 space-y-2 max-h-60 bg-white rounded-xl border border-gray-200 dark:border-white/10 dark:bg-white/5 custom-scrollbar">
              {% for field in dynamic_fields %}
              <label class="flex items-center px-3 py-2 rounded-lg transition-colors cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 group">
                <input type="checkbox" name="editable_fields[]" value="{{ field.id }}" 
                       {% if field in step.editable_fields.all %}checked{% endif %}
                       class="w-4 h-4 bg-transparent rounded border-gray-300 text-neon-violet dark:border-white/20 focus:ring-neon-violet">
                <span class="ml-3 text-sm font-medium text-gray-700 transition-colors dark:text-gray-200 group-hover:text-neon-violet">{{ field.name }}</span>
                <span class="ml-2 text-xs text-gray-500 dark:text-gray-500">({{ field.get_field_type_display }})</span>
              </label>
              {% empty %}
              <p class="p-2 text-sm text-gray-500 dark:text-gray-400">No fields available. Please add fields to this workflow first.</p>
              {% endfor %}
            </div>
            
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Approvers will be able to edit these fields during their approval step.</p>
          </div>
          
          <div x-show="!requiresEdit" class="text-sm italic text-gray-500 dark:text-gray-400">
            Enable "Requires Edit" to allow approvers to edit fields at this step.
          </div>
        </div>
        
        <!-- Form Actions (Sticky) -->
        <div class="flex justify-between items-center mt-8 p-4 glass-card rounded-xl border border-gray-200 dark:border-white/10 sticky bottom-4 z-40 shadow-2xl backdrop-blur-xl bg-white/80 dark:bg-[#0f0f0f]/80">
          <a href="{% url 'document_approval:workflow_steps' workflow.id %}" 
             class="flex gap-2 items-center px-6 py-2.5 text-sm font-medium text-gray-700 bg-transparent rounded-xl border border-transparent transition-colors dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-white/5">
            <i data-lucide="x" class="w-4 h-4"></i>
            Cancel
          </a>
          
          <div class="flex gap-3">
             <!-- Hidden delete form trigger -->
             <button type="button" onclick="document.getElementById('delete-step-form').submit()"
                     class="flex gap-2 items-center px-6 py-2.5 text-sm font-medium text-red-500 rounded-xl border border-transparent transition-colors hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-500/10">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                Delete Step
             </button>
             
             <button type="submit" 
                     class="flex gap-2 items-center px-6 py-2.5 text-sm font-bold text-white rounded-xl shadow-lg transition-all bg-neon-violet hover:bg-neon-purple shadow-neon-violet/30">
               <i data-lucide="save" class="w-4 h-4"></i>
               Update Step
             </button>
          </div>
        </div>
      </form>
      
      <!-- Actual Delete Form (Hidden) -->
      <form id="delete-step-form" method="POST" action="{% url 'document_approval:delete_workflow_step' step.id %}" class="hidden" onsubmit="return confirm('Are you sure you want to delete this step? This action cannot be undone.');">
        {% csrf_token %}
      </form>
    </div>
  </div>
</div>
{% endblock %}
