{% extends "_base.html" %}
{% load static %}

{% block content %}
<!-- Hero Section -->
<div class="mb-10 relative z-10">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white tracking-tight mb-3 relative">
        Create New <br>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-neon-violet to-fuchsia-500 text-glow">Dynamic Field</span>
    </h1>
    <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl">
        Define a new field that can be used in workflows and documents.
    </p>
    <!-- Background Glow -->
    <div class="absolute -top-20 -left-20 w-96 h-96 bg-neon-violet/20 blur-[100px] rounded-full -z-10 pointer-events-none"></div>
</div>

<div class="container mx-auto relative z-10 pb-16">
    
  {% if messages %}
  <div class="mb-6 space-y-2">
    {% for message in messages %}
    <div class="p-4 rounded-xl border backdrop-blur-md
        {% if message.tags == 'success' %}bg-green-500/10 border-green-500/20 text-green-600 dark:text-green-400{% elif message.tags == 'error' %}bg-red-500/10 border-red-500/20 text-red-600 dark:text-red-400{% else %}bg-blue-500/10 border-blue-500/20 text-blue-600 dark:text-blue-400{% endif %}">
      <div class="flex items-center gap-2">
        {% if message.tags == 'success' %}<i data-lucide="check-circle" class="w-5 h-5"></i>{% elif message.tags == 'error' %}<i data-lucide="alert-circle" class="w-5 h-5"></i>{% else %}<i data-lucide="info" class="w-5 h-5"></i>{% endif %}
        {{ message }}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Alpine.js Form -->
  <div x-data="{
    name: '',
    fieldType: 'text',
    inputWidth: 'full',
    required: false,
    order: '',
    
    // Field-specific properties
    choices: '',
    tableColumns: '',
    productListColumns: '',
    allowedExtensions: '',
    textareaRows: 4,
    multipleFiles: false,
    
    // Validation
    errors: {},

    // Preview State
    previewLoading: false,
    
    // Show/hide field-specific options
    showChoices() {
      return this.fieldType === 'choice' || this.fieldType === 'multiple_choice';
    },
    
    showTableColumns() {
      return this.fieldType === 'table_list';
    },
    
    showProductListColumns() {
      return this.fieldType === 'product_list';
    },
    
    showAllowedExtensions() {
      return this.fieldType === 'attachment';
    },
    
    showTextareaRows() {
      return this.fieldType === 'textarea';
    },
    
    showMultipleFiles() {
      return this.fieldType === 'attachment';
    },

    // Helper for icons
    getFieldIcon(type) {
        const map = {
            'text': 'type',
            'number': 'hash',
            'date': 'calendar',
            'boolean': 'toggle-left',
            'choice': 'list',
            'multiple_choice': 'check-square',
            'textarea': 'align-left',
            'attachment': 'paperclip',
            'tiptap_editor': 'file-edit',
            'table_list': 'table',
            'product_list': 'shopping-cart'
        };
        return map[type] || 'box';
    },

    async updatePreview() {
        this.previewLoading = true;
        const previewContainer = document.getElementById('field-preview-container');
        
        const formData = new FormData();
        // Use defaults if empty to ensure preview renders something
        formData.append('name', this.name || 'Untitled Field');
        formData.append('field_type', this.fieldType);
        formData.append('required', this.required);
        formData.append('width', this.inputWidth);
        formData.append('order', this.order || 0);
        
        // Add field-specific data
        if (this.showChoices()) {
            formData.append('choices', this.choices);
        } else if (this.showTableColumns()) {
            formData.append('table_columns', this.tableColumns);
        } else if (this.showProductListColumns()) {
            formData.append('product_list_columns', this.productListColumns);
        } else if (this.showAllowedExtensions()) {
            formData.append('allowed_extensions', this.allowedExtensions);
        }
        
        try {
            const response = await fetch('{% url 'document_approval:field_preview_ajax' %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                const html = await response.text();
                previewContainer.innerHTML = html;
                lucide.createIcons();
            } else {
                console.error('Preview error:', await response.text());
            }
        } catch (error) {
            console.error('Preview fetch error:', error);
        } finally {
            this.previewLoading = false;
        }
    },
    
    validateForm() {
      this.errors = {};
      
      if (!this.name) this.errors.name = 'Field name is required';
      if (!this.order) this.errors.order = 'Order is required';
      
      if (this.showChoices() && !this.choices) {
        this.errors.choices = 'Choices are required for this field type';
      }
      
      if (this.showTableColumns() && !this.tableColumns) {
        this.errors.tableColumns = 'Table columns are required for this field type';
      }
      
      if (this.showProductListColumns() && !this.productListColumns) {
        this.errors.productListColumns = 'Product list columns are required for this field type';
      }
      
      return Object.keys(this.errors).length === 0;
    }
  }" 
  x-init="$watch('fieldType', () => updatePreview()); 
          $watch('name', () => setTimeout(() => updatePreview(), 500)); // Debounce name
          $watch('required', () => updatePreview());
          updatePreview();"
  class="space-y-8">
    
    <div class="glass-card rounded-2xl p-8 md:p-10 border border-gray-200 dark:border-white/10 shadow-xl">
        <form method="POST" action="" @submit.prevent="if(validateForm()) $el.submit()">
        {% csrf_token %}
        {% if request.GET.id %}
        <input type="hidden" name="workflow_id" value="{{ request.GET.id }}">
        {% endif %}
        {% if request.GET.next %}
        <input type="hidden" name="next" value="{{ request.GET.next }}{% if request.GET.id %}&id={{ request.GET.id }}{% endif %}">
        {% endif %}
        
        <div class="grid grid-cols-1 gap-y-8 gap-x-6 sm:grid-cols-6">
            
            <!-- Section Header -->
            <div class="sm:col-span-6 border-b border-gray-200 dark:border-white/10 pb-4 mb-2">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <div class="p-2 rounded-lg bg-blue-500/10 text-blue-500 dark:text-blue-400 border border-blue-500/20">
                        <i data-lucide="settings-2" class="w-5 h-5"></i>
                    </div>
                    General Settings
                </h2>
            </div>

            <!-- Field Name -->
            <div class="sm:col-span-3">
                <label for="name" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Field Name</label>
                <input type="text" name="name" id="name" x-model="name" 
                        class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent placeholder-gray-400 dark:placeholder-gray-600"
                        :class="{'border-red-500': errors.name}">
                <p x-show="errors.name" x-text="errors.name" class="mt-1 text-sm text-red-500"></p>
            </div>

            <!-- Order -->
            <div class="sm:col-span-3">
                <label for="order" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Order</label>
                <input type="number" name="order" id="order" x-model="order" 
                        class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                        :class="{'border-red-500': errors.order}">
                <p x-show="errors.order" x-text="errors.order" class="mt-1 text-sm text-red-500"></p>
            </div>

            <!-- Field Type (Visual Grid) -->
            <div class="sm:col-span-6">
                <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Field Type</label>
                <input type="hidden" name="field_type" id="field_type" x-model="fieldType">
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    {% for choice in field_type_choices %}
                    <button type="button" 
                            @click="fieldType = '{{ choice.value }}'"
                            class="relative flex flex-col items-center justify-center p-4 rounded-xl border transition-all duration-200 group text-center h-full"
                            :class="fieldType === '{{ choice.value }}' 
                                ? 'bg-neon-violet/10 border-neon-violet text-neon-violet ring-1 ring-neon-violet' 
                                : 'bg-white dark:bg-white/5 border-gray-200 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:border-neon-violet/50 hover:bg-gray-50 dark:hover:bg-white/10'">
                        
                        <div class="mb-3 p-2 rounded-full transition-colors"
                             :class="fieldType === '{{ choice.value }}' ? 'bg-neon-violet/20 text-neon-violet' : 'bg-gray-100 dark:bg-white/10 text-gray-500 dark:text-gray-400 group-hover:text-neon-violet group-hover:bg-neon-violet/10'">
                             <!-- Dynamic Icon based on value -->
                             <i :data-lucide="getFieldIcon('{{ choice.value }}')" class="w-6 h-6"></i>
                        </div>
                        
                        <span class="text-sm font-medium">{{ choice.display }}</span>
                        
                        <!-- Checkmark for selected state -->
                        <div x-show="fieldType === '{{ choice.value }}'" class="absolute top-2 right-2 text-neon-violet">
                            <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                        </div>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Field Width (Visual Segmented Control) -->
            <div class="sm:col-span-6">
                <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Field Width</label>
                <input type="hidden" name="width" id="width" x-model="inputWidth">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {% for value, display in width_choices %}
                    <button type="button" 
                            @click="inputWidth = '{{ value }}'"
                            class="flex items-center justify-center px-4 py-3 rounded-lg border transition-all duration-200 font-medium text-sm"
                            :class="inputWidth === '{{ value }}'
                                ? 'bg-neon-violet/10 border-neon-violet text-neon-violet ring-1 ring-neon-violet'
                                : 'bg-white dark:bg-white/5 border-gray-200 dark:border-white/10 text-gray-600 dark:text-gray-400 hover:border-neon-violet/50 hover:bg-gray-50 dark:hover:bg-white/10'">
                        
                         <!-- Visual representation of width -->
                         <div class="w-4 h-4 rounded-sm border mr-2 flex overflow-hidden bg-gray-200 dark:bg-gray-700"
                              :class="inputWidth === '{{ value }}' ? 'border-neon-violet' : 'border-gray-400 dark:border-gray-500'">
                            {% if value == 'full' %}
                                <div class="w-full h-full" :class="inputWidth === '{{ value }}' ? 'bg-neon-violet' : 'bg-gray-400 dark:bg-gray-500'"></div>
                            {% elif value == '1/2' %}
                                <div class="w-1/2 h-full" :class="inputWidth === '{{ value }}' ? 'bg-neon-violet' : 'bg-gray-400 dark:bg-gray-500'"></div>
                            {% elif value == '1/3' %}
                                <div class="w-1/3 h-full" :class="inputWidth === '{{ value }}' ? 'bg-neon-violet' : 'bg-gray-400 dark:bg-gray-500'"></div>
                            {% elif value == '2/3' %}
                                <div class="w-2/3 h-full" :class="inputWidth === '{{ value }}' ? 'bg-neon-violet' : 'bg-gray-400 dark:bg-gray-500'"></div>
                            {% else %}
                                <div class="w-full h-full" :class="inputWidth === '{{ value }}' ? 'bg-neon-violet' : 'bg-gray-400 dark:bg-gray-500'"></div>
                            {% endif %}
                         </div>
                         
                        {{ display }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Required Checkbox -->
            <div class="sm:col-span-6">
                <label class="flex items-center p-4 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors group">
                    <input id="required" name="required" type="checkbox" x-model="required"
                            class="w-5 h-5 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                    <input type="hidden" :value="required ? 'true' : 'false'" name="required_hidden">
                    <div class="ml-3">
                        <span class="block text-sm font-bold text-gray-900 dark:text-white group-hover:text-neon-violet transition-colors">Required Field</span>
                        <span class="block text-xs text-gray-500 dark:text-gray-400">Make this field mandatory when submitting documents</span>
                    </div>
                </label>
            </div>

            <!-- Field-specific options container -->
            <div class="sm:col-span-6 mt-4 pt-6 border-t border-gray-200 dark:border-white/10" 
                 x-show="showChoices() || showTableColumns() || showProductListColumns() || showAllowedExtensions() || showTextareaRows() || showMultipleFiles()" 
                 x-transition>
                
                <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2 mb-6">
                    <div class="p-2 rounded-lg bg-purple-500/10 text-purple-500 dark:text-purple-400 border border-purple-500/20">
                        <i data-lucide="sliders" class="w-5 h-5"></i>
                    </div>
                    Type Specific Settings
                </h2>

                <div class="grid grid-cols-1 gap-y-6">
                    <!-- Choices for choice and multiple_choice fields -->
                    <div x-show="showChoices()">
                        <label for="choices" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Choices</label>
                        <input type="text" id="choices" name="choices" x-model="choices" @input.debounce.500ms="updatePreview()"
                                class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                                :class="{'border-red-500': errors.choices}">
                        <p x-show="errors.choices" x-text="errors.choices" class="mt-1 text-sm text-red-500"></p>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i> Enter choices separated by commas (e.g., Option 1,Option 2,Option 3)
                        </p>
                    </div>

                    <!-- Table columns for table_list fields -->
                    <div x-show="showTableColumns()">
                        <label for="table_columns" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Table Columns</label>
                        <input type="text" id="table_columns" name="table_columns" x-model="tableColumns" @input.debounce.500ms="updatePreview()"
                                class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                                :class="{'border-red-500': errors.tableColumns}">
                        <p x-show="errors.tableColumns" x-text="errors.tableColumns" class="mt-1 text-sm text-red-500"></p>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i> Enter column names separated by pipes (|) e.g., "item|name|qty|invoice|reason|credit"
                        </p>
                    </div>

                    <!-- Product list columns for product_list fields -->
                    <div x-show="showProductListColumns()">
                        <label for="product_list_columns" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Product List Columns</label>
                        <input type="text" id="product_list_columns" name="product_list_columns" x-model="productListColumns" @input.debounce.500ms="updatePreview()"
                                class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                                :class="{'border-red-500': errors.productListColumns}">
                        <p x-show="errors.productListColumns" x-text="errors.productListColumns" class="mt-1 text-sm text-red-500"></p>
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i> Enter column names separated by pipes (|)
                        </p>
                    </div>

                    <!-- Allowed extensions for attachment fields -->
                    <div x-show="showAllowedExtensions()">
                        <label for="allowed_extensions" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Allowed Extensions</label>
                        <input type="text" id="allowed_extensions" name="allowed_extensions" x-model="allowedExtensions" @input.debounce.500ms="updatePreview()"
                                class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent">
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
                            <i data-lucide="info" class="w-3 h-3"></i> Enter file extensions separated by commas (e.g., pdf,doc,docx). Leave empty to allow all types.
                        </p>
                    </div>
                    
                    <!-- Textarea Rows -->
                    <div x-show="showTextareaRows()">
                        <label for="textarea_rows" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Textarea Rows</label>
                        <input type="number" id="textarea_rows" name="textarea_rows" x-model="textareaRows" @input.debounce.500ms="updatePreview()"
                                min="1" max="20"
                                class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent">
                        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Number of rows to display in the textarea (1-20)</p>
                    </div>
                    
                    <!-- Multiple Files -->
                    <div x-show="showMultipleFiles()">
                        <label class="flex items-center p-4 rounded-lg bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 cursor-pointer hover:bg-gray-100 dark:hover:bg-white/10 transition-colors group">
                            <input id="multiple_files" name="multiple_files" type="checkbox" x-model="multipleFiles" @change="updatePreview()"
                                   class="w-5 h-5 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                            <input type="hidden" :value="multipleFiles ? 'true' : 'false'" name="multiple_files_hidden">
                            <div class="ml-3">
                                <span class="block text-sm font-bold text-gray-900 dark:text-white group-hover:text-neon-violet transition-colors">Allow Multiple Files</span>
                                <span class="block text-xs text-gray-500 dark:text-gray-400">Allow users to upload multiple files for this attachment field</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-white/10 flex items-center justify-end gap-4">
            <a href="{% if request.GET.next == 'document_approval:edit_workflow' and request.GET.id %}{% url 'document_approval:edit_workflow' workflow_id=request.GET.id %}{% else %}{% url 'document_approval:field_list' %}{% endif %}" 
               class="px-6 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-transparent hover:bg-gray-100 dark:hover:bg-white/5 rounded-xl transition-colors border border-transparent flex items-center gap-2">
                <i data-lucide="x" class="w-4 h-4"></i>
                Cancel
            </a>
            <button type="submit"
                    class="px-6 py-2.5 text-sm font-bold text-white bg-neon-violet hover:bg-neon-purple rounded-xl shadow-lg shadow-neon-violet/30 transition-all flex items-center gap-2">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                Create Field
            </button>
        </div>
        </form>
    </div>
    
    <!-- Field Preview -->
    <div class="mt-8">
        <div class="flex justify-between items-center mb-4 px-2">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
                <div class="p-2 rounded-lg bg-amber-500/10 text-amber-500 dark:text-amber-400 border border-amber-500/20">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                </div>
                Field Preview
            </h2>
            <div x-show="previewLoading" class="text-neon-violet animate-spin">
                <i data-lucide="loader-2" class="w-5 h-5"></i>
            </div>
        </div>
        
        <div class="glass-card rounded-2xl p-6 border border-gray-200 dark:border-white/10 shadow-lg">
            <div id="field-preview-container">
                <!-- Preview will be loaded here -->
                <div class="flex flex-col items-center justify-center py-12 text-gray-500 dark:text-gray-400">
                    <i data-lucide="layout-template" class="w-12 h-12 mb-4 opacity-50"></i>
                    <p class="text-sm text-center">
                        Select a field type to see the preview
                    </p>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
{% endblock %}
