{% extends "_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<style>
  .workflow-select-btn { background-color: white; border-color: #e5e7eb; color: #111827; }
  .dark .workflow-select-btn { background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); color: white; }
  
  .workflow-dropdown-bg { background-color: white; border-color: #e5e7eb; }
  .dark .workflow-dropdown-bg { background-color: #1e1e1e; border-color: rgba(255, 255, 255, 0.1); }
  
  .workflow-text { color: #111827; }
  .dark .workflow-text { color: white; }
  
  .workflow-dropdown-item:hover { background-color: #f3f4f6; }
  .dark .workflow-dropdown-item:hover { background-color: rgba(255, 255, 255, 0.1); }
</style>
<!-- Hero Section -->
<div class="mb-10 relative z-10">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white tracking-tight mb-3 relative">
        Create <br>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-neon-violet to-fuchsia-500 text-glow">Workflow Step</span>
    </h1>
    <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl">
        Add a new approval step to: <span class="font-medium text-neon-violet">{{ workflow.name }}</span>
    </p>
    <!-- Background Glow -->
    <div class="absolute -top-20 -left-20 w-96 h-96 bg-neon-violet/20 blur-[100px] rounded-full -z-10 pointer-events-none"></div>
</div>

<div class="container mx-auto relative z-10">
  <div class="glass-card rounded-2xl p-8 md:p-10 border border-gray-200 dark:border-white/10 shadow-xl">
    
    <!-- Alpine.js Form -->
    <div x-data="{
      name: '',
      order: '',
      approvalMode: 'all',
      requiresEdit: false,
      allowCustomApprover: false,
      
      // Approvers
      approverType: 'none',
      selectedApprovers: [],
      approverGroups: [],
      
      // Conditional Logic
      isConditional: false,
      moveToNext: true,
      conditionField: '',
      conditionOperator: 'equals',
      conditionValue: '',
      
      // Lookups for Custom Selects
      fieldMap: {
        {% for field in dynamic_fields %}
        {{ field.id }}: '{{ field.name|escapejs }}'{% if not forloop.last %}, {% endif %}
        {% endfor %}
      },
      operatorMap: {
        {% for operator, display in condition_operators %}
        '{{ operator }}': '{{ display|escapejs }}'{% if not forloop.last %}, {% endif %}
        {% endfor %}
      },
      
      // Input Type
      inputType: 'none',
      inputLabel: '',
      inputOptions: '',
      
      // Validation
      errors: {},
      
      validateForm() {
        this.errors = {};
        
        if (!this.name) this.errors.name = 'Name is required';
        if (!this.order) this.errors.order = 'Order is required';
        
        if (this.approverType === 'specific' && this.selectedApprovers.length === 0) {
          this.errors.approvers = 'Please select at least one approver';
        }
        
        if (this.approverType === 'group' && this.approverGroups.length === 0) {
          this.errors.approverGroups = 'Please select at least one approver group';
        }
        
        if (this.isConditional) {
          if (!this.conditionField) this.errors.conditionField = 'Condition field is required';
          if (!this.conditionValue) this.errors.conditionValue = 'Condition value is required';
        }
        
        if (this.inputType === 'choice' && !this.inputOptions) {
          this.errors.inputOptions = 'Options are required for choice input';
        }
        
        if (this.inputType !== 'none' && !this.inputLabel) {
          this.errors.inputLabel = 'Input label is required';
        }
        
        return Object.keys(this.errors).length === 0;
      }
    }" class="space-y-8">
      <form method="POST" action="" @submit.prevent="if(validateForm()) $el.submit()">
        {% csrf_token %}
        
        <!-- Basic Information Section -->
        <div class="p-6 rounded-xl bg-gray-50/50 dark:bg-white/5 border border-gray-200 dark:border-white/10">
          <h2 class="mb-6 text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <i data-lucide="info" class="w-5 h-5 text-neon-violet"></i>
            Basic Information
          </h2>
          
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
            <!-- Step Name -->
            <div>
              <label for="name" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Step Name</label>
              <input type="text" name="name" id="name" x-model="name" 
                     class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                     :class="{'border-red-500': errors.name}">
              <p x-show="errors.name" x-text="errors.name" class="mt-1 text-sm text-red-500"></p>
            </div>
            
            <!-- Step Order -->
            <div>
              <label for="order" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Order</label>
              <input type="number" name="order" id="order" x-model="order" min="1"
                     class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                     :class="{'border-red-500': errors.order}">
              <p x-show="errors.order" x-text="errors.order" class="mt-1 text-sm text-red-500"></p>
            </div>
          </div>
          
          <div class="mt-6">
            <!-- Approval Mode -->
            <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Approval Mode</label>
            <div class="flex flex-wrap gap-4">
              <label class="inline-flex items-center cursor-pointer">
                <input type="radio" name="approval_mode" value="all" x-model="approvalMode" class="w-4 h-4 text-neon-violet border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">All Approvers Required</span>
              </label>
              <label class="inline-flex items-center cursor-pointer">
                <input type="radio" name="approval_mode" value="any" x-model="approvalMode" class="w-4 h-4 text-neon-violet border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Any Approver Sufficient</span>
              </label>
            </div>
          </div>
        </div>
        
        <!-- Approvers Section -->
        <div class="p-6 rounded-xl bg-gray-50/50 dark:bg-white/5 border border-gray-200 dark:border-white/10">
          <h2 class="mb-6 text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <i data-lucide="users" class="w-5 h-5 text-neon-violet"></i>
            Approvers
          </h2>

          <div class="flex items-center mb-6">
            <input id="allow_custom_approver" name="allow_custom_approver" type="checkbox" 
                   :checked="allowCustomApprover"
                   @change="allowCustomApprover = $event.target.checked"
                   class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
            <input type="hidden" name="allow_custom_approver_value" :value="allowCustomApprover ? 'on' : 'off'">
            <label for="allow_custom_approver" class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
              Allow Custom Approver selection during workflow
            </label>
          </div>
          
          <div class="mb-6">
            <label class="block mb-3 text-sm font-bold text-gray-700 dark:text-gray-300">Approver Type</label>
            <div class="flex flex-wrap gap-4">
              <label class="inline-flex items-center cursor-pointer">
                <input type="radio" value="specific" x-model="approverType" class="w-4 h-4 text-neon-violet border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Specific Users</span>
              </label>
              <label class="inline-flex items-center cursor-pointer" x-show="allowCustomApprover">
                <input type="radio" value="group" x-model="approverType" class="w-4 h-4 text-neon-violet border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">User Group</span>
              </label>
            </div>
          </div>
          
          <!-- Specific Approvers -->
          <div x-show="approverType === 'specific'" class="mb-4">
            <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Select Approvers</label>
            <div class="p-4 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 max-h-60 overflow-y-auto custom-scrollbar space-y-2"
                 :class="{'border-red-500': errors.approvers}">
              {% for user in users %}
              <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer transition-colors">
                <input type="checkbox" name="approvers[]" value="{{ user.id }}" 
                       x-model="selectedApprovers" class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-3 text-sm text-gray-700 dark:text-gray-200">{{ user.get_full_name|default:user.username }}</span>
              </label>
              {% endfor %}
            </div>
            <p x-show="errors.approvers" x-text="errors.approvers" class="mt-1 text-sm text-red-500"></p>
          </div>
          
          <!-- Approver Groups (Multiple Selection) -->
          <div x-show="approverType === 'group'" class="mb-4">
            <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Select Groups</label>
            <div class="p-4 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 max-h-60 overflow-y-auto custom-scrollbar space-y-2"
                 :class="{'border-red-500': errors.approverGroups}">
              {% for group in groups %}
              <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer transition-colors">
                <input type="checkbox" name="approver_groups[]" value="{{ group.id }}" 
                       x-model="approverGroups" class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-3 text-sm text-gray-700 dark:text-gray-200">{{ group.name }}</span>
              </label>
              {% endfor %}
            </div>
            <p x-show="errors.approverGroups" x-text="errors.approverGroups" class="mt-1 text-sm text-red-500"></p>
          </div>
        </div>
        
        <!-- Conditional Logic Section -->
        <div class="p-6 rounded-xl bg-gray-50/50 dark:bg-white/5 border border-gray-200 dark:border-white/10">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <i data-lucide="git-branch" class="w-5 h-5 text-neon-violet"></i>
              Conditional Logic
            </h2>
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="isConditional" class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
              <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Enable Conditional Logic</span>
            </label>
            <input type="hidden" :value="isConditional ? 'true' : 'false'" name="is_conditional">
          </div>
          
          <div x-show="isConditional" class="space-y-4" x-transition>
            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
              <!-- Condition Field -->
              <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Field</label>
                <button type="button" @click="open = !open"
                        class="workflow-select-btn relative w-full px-4 py-2.5 text-left rounded-lg border focus:ring-2 focus:ring-neon-violet focus:border-transparent flex items-center justify-between"
                        :class="{'border-red-500': errors.conditionField}">
                  <span x-text="conditionField ? fieldMap[conditionField] : '-- Select Field --'"></span>
                  <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                
                <div x-show="open" x-transition class="workflow-dropdown-bg absolute z-50 w-full mt-1 overflow-auto rounded-lg shadow-lg max-h-60 border">
                  {% for field in dynamic_fields %}
                  <div @click="conditionField = '{{ field.id }}'; open = false"
                       class="workflow-dropdown-item workflow-text px-4 py-2 cursor-pointer">
                    {{ field.name }}
                  </div>
                  {% endfor %}
                </div>
                <select name="condition_field" x-model="conditionField" class="hidden">
                  <option value="">-- Select Field --</option>
                  {% for field in dynamic_fields %}
                  <option value="{{ field.id }}">{{ field.name }}</option>
                  {% endfor %}
                </select>
                <p x-show="errors.conditionField" x-text="errors.conditionField" class="mt-1 text-sm text-red-500"></p>
              </div>
              
              <!-- Condition Operator -->
              <div class="relative" x-data="{ open: false }" @click.away="open = false">
                <label class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Operator</label>
                <button type="button" @click="open = !open"
                        class="workflow-select-btn relative w-full px-4 py-2.5 text-left rounded-lg border focus:ring-2 focus:ring-neon-violet focus:border-transparent flex items-center justify-between">
                  <span x-text="operatorMap[conditionOperator] || conditionOperator"></span>
                  <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                
                <div x-show="open" x-transition class="workflow-dropdown-bg absolute z-50 w-full mt-1 overflow-auto rounded-lg shadow-lg max-h-60 border">
                  {% for operator, display in condition_operators %}
                  <div @click="conditionOperator = '{{ operator }}'; open = false"
                       class="workflow-dropdown-item workflow-text px-4 py-2 cursor-pointer">
                    {{ display }}
                  </div>
                  {% endfor %}
                </div>
                <select name="condition_operator" x-model="conditionOperator" class="hidden">
                  {% for operator, display in condition_operators %}
                  <option value="{{ operator }}">{{ display }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Condition Value -->
              <div>
                <label for="condition_value" class="block mb-2 text-sm font-bold text-gray-700 dark:text-gray-300">Value</label>
                <input type="text" name="condition_value" id="condition_value" x-model="conditionValue"
                       class="w-full px-4 py-2.5 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 text-gray-900 dark:text-white focus:ring-2 focus:ring-neon-violet focus:border-transparent"
                       :class="{'border-red-500': errors.conditionValue}">
                <p x-show="errors.conditionValue" x-text="errors.conditionValue" class="mt-1 text-sm text-red-500"></p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Workflow Flow Control Section -->
        <div class="p-6 rounded-xl bg-gray-50/50 dark:bg-white/5 border border-gray-200 dark:border-white/10">
          <h2 class="mb-4 text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <i data-lucide="arrow-right-circle" class="w-5 h-5 text-neon-violet"></i>
            Workflow Flow Control
          </h2>
          
          <!-- Move to Next Step -->
          <div class="flex items-center">
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="moveToNext" class="w-5 h-5 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent" checked>
              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Move to next step after this step</span>
            </label>
          </div>
          <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">If unchecked, workflow will complete after this step (when condition is met for conditional steps)</p>
          <input type="hidden" :value="moveToNext ? 'true' : 'false'" name="move_to_next">
        </div>
        
        <!-- Editable Fields Section -->
        <div class="p-6 rounded-xl bg-gray-50/50 dark:bg-white/5 border border-gray-200 dark:border-white/10">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center gap-2">
              <i data-lucide="edit-3" class="w-5 h-5 text-neon-violet"></i>
              Editable Fields
            </h2>
            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" x-model="requiresEdit" class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
              <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">Requires Edit</span>
            </label>
          </div>
          
          <div x-show="requiresEdit" class="space-y-4" x-transition>
            <p class="mb-3 text-sm text-gray-600 dark:text-gray-400">Select which fields can be edited by approvers at this step:</p>
            
            <div class="p-4 rounded-lg bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 max-h-60 overflow-y-auto custom-scrollbar space-y-2">
              {% for field in dynamic_fields %}
              <label class="flex items-center px-2 py-1 rounded-lg hover:bg-gray-50 dark:hover:bg-white/5 cursor-pointer transition-colors">
                <input type="checkbox" name="editable_fields[]" value="{{ field.id }}" 
                       class="w-4 h-4 text-neon-violet rounded border-gray-300 dark:border-white/20 focus:ring-neon-violet bg-transparent">
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-200">{{ field.name }}</span>
                <span class="ml-1 text-xs text-gray-500 dark:text-gray-500">({{ field.get_field_type_display }})</span>
              </label>
              {% empty %}
              <p class="p-2 text-sm text-gray-500 dark:text-gray-400">No fields available. Please add fields to this workflow first.</p>
              {% endfor %}
            </div>
            
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Approvers will be able to edit these fields during their approval step.</p>
          </div>
          
          <div x-show="!requiresEdit" class="text-sm italic text-gray-500 dark:text-gray-400">
            Enable "Requires Edit" to allow approvers to edit fields at this step.
          </div>
        </div>
        
        <!-- Form Actions -->
        <div class="flex justify-between items-center mt-8 p-4 glass-card rounded-xl border border-gray-200 dark:border-white/10 sticky bottom-4 z-40 shadow-2xl">
          <a href="{% url 'document_approval:workflow_steps' workflow.id %}" 
             class="px-6 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-transparent hover:bg-gray-100 dark:hover:bg-white/5 rounded-xl transition-colors border border-transparent flex items-center gap-2">
            <i data-lucide="x" class="w-4 h-4"></i>
            Cancel
          </a>
          <button type="submit" 
                  class="px-6 py-2.5 text-sm font-bold text-white bg-neon-violet hover:bg-neon-purple rounded-xl shadow-lg shadow-neon-violet/30 transition-all flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Create Step
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
