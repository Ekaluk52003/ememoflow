{% extends '_base.html' %}

{% block title %}Create Authorization{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Create Authorization</h1>
            <a href="{% url 'document_approval:authorization_list' %}" class="text-blue-500 hover:text-blue-700">
                Back to Authorizations
            </a>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            {% if error_message %}
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700">
                    <p>{{ error_message }}</p>
                </div>
            {% endif %}
            
            <form method="post" action="{% url 'document_approval:create_authorization' %}" x-data="{ currentDate: new Date().toISOString().slice(0, 16) }">
                {% csrf_token %}
                
                <div class="space-y-4">
                    <!-- Authorized User -->
                    <div class="form-group">
                        <label for="authorized_user" class="block text-sm font-medium text-gray-700 mb-1">
                            Authorize User *
                        </label>
                       <div x-data="{ users: [], loading: true }" class="relative">
                            <select name="authorized_user" id="authorized_user" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required :disabled="loading" :class="{'bg-gray-200 text-gray-500': loading}"
                                x-init="fetch('/document/api/users/')
                                        .then(response => response.json())
                                        .then(data => { 
                                            users = data.filter(u => u.id != {{ request.user.id }}); 
                                            loading = false; 
                                        })
                                        .catch(error => {
                                            console.error('Error fetching users:', error);
                                            loading = false;
                                        })">
                                <option value="">Select a user</option>
                                <template x-for="user in users" :key="user.id">
                                    <option :value="user.id" x-text="user.username"></option>
                                </template>
                            </select>
                            
                            <!-- Loading message -->
                            <div x-show="loading" class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <span class="text-sm text-blue-500 font-medium">Loading data...</span>
                            </div>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Select the user who will approve documents on your behalf</p>
                    </div>
                    
                    <!-- Valid From -->
                    <div class="form-group">
                        <label for="valid_from" class="block text-sm font-medium text-gray-700 mb-1">
                            Valid From *
                        </label>
                        <input type="datetime-local" name="valid_from" id="valid_from" 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               x-bind:min="currentDate"
                               x-bind:value="currentDate"
                               required>
                        <p class="mt-1 text-xs text-gray-500">When this authorization becomes active</p>
                    </div>
                    
                    <!-- Valid Until -->
                    <div class="form-group">
                        <label for="valid_until" class="block text-sm font-medium text-gray-700 mb-1">
                            Valid Until *
                        </label>
                        <input type="datetime-local" name="valid_until" id="valid_until" 
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                               x-bind:min="currentDate"
                               required>
                        <p class="mt-1 text-xs text-gray-500">When this authorization expires</p>
                    </div>
                    
                    <!-- Reason -->
                    <div class="form-group">
                        <label for="reason" class="block text-sm font-medium text-gray-700 mb-1">
                            Reason *
                        </label>
                        <textarea name="reason" id="reason" rows="3" 
                                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                  required></textarea>
                        <p class="mt-1 text-xs text-gray-500">Reason for the authorization (e.g., vacation, business trip)</p>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded shadow">
                        Create Authorization
                    </button>
                </div>
            </form>
        </div>

</div>
{% endblock %}
