{% load static %}

<!DOCTYPE html>
<html lang="en" class="h-full bg-base-100">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
  <title>{% block title %}SmartFlow{% endblock title %}</title>
  <meta name="description" content="A framework for launching new Django projects quickly.">
  <meta name="author" content="">
  <link rel="shortcut icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">

  {% block css %}



  <link href="{% static 'dist/styles.css' %}" rel="stylesheet">
  {% endblock %}
</head>

<body  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
  <!-- Progress Bar -->
  <div class="progress" style="height: 3px; background-color: white;">
    <div class="indeterminate" style="background-color: #0d6efd;"></div>
  </div>

  <!-- Toast -->
  <div id="toasts"></div>

  <div class="flex"  x-data="{ sidebarOpen: false }">

    <!-- sidebar -->
    <div class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 transform transition-transform duration-300 md:relative md:translate-x-0"
         :class="{'translate-x-0': sidebarOpen, '-translate-x-full': !sidebarOpen}">
        <div class="flex items-center justify-center h-16 bg-gray-900">
            <span class="text-white font-bold uppercase">Sidebar</span>
        </div>
        <div class="flex flex-col flex-1">
            <nav class="flex-1 px-2 py-4 bg-gray-800">
                {% if request.user.is_authenticated %}
                <a href="{% url 'document_approval:documents_to_approve' %}" class="flex items-center justify-between px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'documents_to_approve' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        Your Tasks
                    </div>
                    {% if pending_count > 0 %}
                    <span class="flex items-center justify-center w-6 h-6 text-sm font-medium text-blue-800 bg-blue-100 rounded-full">          
                        {{ pending_count }}
                    </span>
                    {% endif %}
                </a>
                
                <div x-data="{ isOpen: false }" >
                    <a @click="isOpen = !isOpen" class="flex items-center justify-between px-4 py-2 text-gray-100 hover:bg-gray-700">
                        <div class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            Workflows
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" :class="{'rotate-180': isOpen}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </a>
                    
                    <div x-show="isOpen" x-cloak
                         @click.away="isOpen = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         >
                        <div class="py-1">
                            {% for workflow in workflows %}
                            <a href="{% url 'document_approval:submit_document' workflow.id %}" 
                               class="flex items-center px-8 py-2 text-gray-100 hover:bg-gray-700">
                                {{ workflow.name }}
                            </a>
                            {% empty %}
                            <div class="px-8 py-2 text-sm text-gray-100">
                                No workflows available.
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <a href="{% url 'document_approval:document_list' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'document_list' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                    </svg>
                    All documents
                </a>

                <a href="{% url 'document_approval:favorite_documents' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'favorite_documents' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                    Favorite Documents
                </a>

<!-- Replace the existing notification menu with this -->

<div x-data="{ 
  isOpen: false,
  notifications: [],
  notificationCount: 0,
  soundEnabled: localStorage.getItem('soundEnabled') !== 'false',
  notificationSound: new Audio('/static/sounds/notification.mp3'),
  ws: null,
  connectionStatus: 'disconnected',
  
  initWebSocket() {
      this.connectWebSocket();
      
      // Reconnect when tab becomes visible
      document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible' && !this.ws) {
              this.connectWebSocket();
          }
      });
  },
  
  connectWebSocket() {
      const userId = '{{ request.user.id }}';
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const isDevelopment = window.location.port === '8000';
      const wsUrl = isDevelopment 
          ? `${wsProtocol}//127.0.0.1:8001/ws/${userId}`  // Development: direct to WebSocket port
          : `${wsProtocol}//${window.location.host}/ws/${userId}`;  // Production: through Caddy
      
      this.ws = new WebSocket(wsUrl);
      
      this.ws.onopen = () => {
          this.connectionStatus = 'connected';
          console.log('WebSocket connected');
      };
      
      this.ws.onmessage = (event) => {
          const notification = JSON.parse(event.data);
          this.notifications.unshift(notification);
          this.notificationCount = this.notifications.length;
          this.saveNotifications();
          this.playNotificationSound();
      };
      
      this.ws.onclose = () => {
          this.connectionStatus = 'disconnected';
          console.log('WebSocket disconnected');
          
          // Attempt to reconnect after 5 seconds
          setTimeout(() => {
              if (document.visibilityState === 'visible') {
                  this.connectWebSocket();
              }
          }, 5000);
      };

      this.ws.onerror = () => {
          this.connectionStatus = 'error';
          console.error('WebSocket error occurred');
      };
  },
  
  getConnectionStatusText() {
      const statusMap = {
          'connected': '',
          'disconnected': 'Reconnecting...',
          'error': 'Connection Error'
      };
      return statusMap[this.connectionStatus] || '';
  },

  clearAll() {
      this.notifications = [];
      this.notificationCount = 0;
      this.saveNotifications();
  },

  removeNotification(index) {
      this.notifications.splice(index, 1);
      this.notificationCount = this.notifications.length;
      this.saveNotifications();
  },

  formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
      });
  },
  
  saveNotifications() {
      try {
          localStorage.setItem('notifications', JSON.stringify(this.notifications));
          localStorage.setItem('soundEnabled', this.soundEnabled);
      } catch (error) {
          console.error('Error saving notifications:', error);
          if (error.name === 'QuotaExceededError') {
              this.notifications = this.notifications.slice(-50);
              this.saveNotifications();
          }
      }
  },
  
  loadNotifications() {
      try {
          const stored = localStorage.getItem('notifications');
          if (stored) {
              this.notifications = JSON.parse(stored);
              this.notificationCount = this.notifications.length;
          }
      } catch (error) {
          console.error('Error loading notifications:', error);
          this.notifications = [];
          this.notificationCount = 0;
      }
  },
  
  playNotificationSound() {
      if (!this.soundEnabled) return;
      try {
          this.notificationSound.currentTime = 0;
          this.notificationSound.play().catch(error => {
              console.warn('Could not play notification sound:', error);
          });
      } catch (error) {
          console.error('Error playing sound:', error);
      }
  },
  
  toggleSound() {
      this.soundEnabled = !this.soundEnabled;
      localStorage.setItem('soundEnabled', this.soundEnabled);
  },
  
  handleNotificationClick(index) {
      const notification = this.notifications[index];
      if (notification && notification.url) {
          this.notifications.splice(index, 1);
          this.notificationCount = this.notifications.length;
          this.saveNotifications();
          window.location.href = notification.url;
      }
  }
}" 
x-init="initWebSocket(); loadNotifications()"
class="relative inline-block">
    <button @click="isOpen = !isOpen" 
            class="flex items-center justify-between px-4 py-2 text-gray-100 hover:bg-gray-700 transition-colors duration-200 rounded-md">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span class="font-medium">Notifications</span>
            <span x-show="connectionStatus !== 'connected'" 
                  class="ml-2 text-xs font-medium px-2 py-0.5 rounded-full"
                  :class="{
                      'bg-yellow-100 text-yellow-800': connectionStatus === 'disconnected',
                      'bg-red-100 text-red-800': connectionStatus === 'error'
                  }"
                  x-text="getConnectionStatusText()">
            </span>
        </div>
        <div class="flex items-center space-x-2 ml-2">
            <template x-if="notificationCount > 0">
                <span class="flex items-center justify-center w-6 h-6 text-sm font-semibold text-blue-800 bg-blue-100 rounded-full transition-all duration-300 transform hover:scale-110" 
                      x-text="notificationCount">
                </span>
            </template>
            <svg xmlns="http://www.w3.org/2000/svg" 
                 class="h-4 w-4 transition-transform duration-200" 
                 :class="{'rotate-180': isOpen}" 
                 fill="none" 
                 viewBox="0 0 24 24" 
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </div>
    </button>

    <!-- Notification Panel -->
    <div x-show="isOpen" 
         x-cloak
         @click.away="isOpen = false"
         x-transition:enter="transition ease-out duration-100"
         x-transition:enter-start="transform opacity-0 scale-95"
         x-transition:enter-end="transform opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-75"
         x-transition:leave-start="transform opacity-100 scale-100"
         x-transition:leave-end="transform opacity-0 scale-95"
         class="mt-2 w-64 origin-top-right rounded-md bg-gray-800 py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
        
        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-700">
            <div class="flex justify-between items-center">
                <h3 class="text-sm font-semibold text-gray-100">Notifications</h3>
                <div class="flex items-center space-x-4">
                    <button @click="toggleSound()" 
                            class="text-gray-400 hover:text-gray-100 transition-colors duration-200"
                            :title="soundEnabled ? 'Mute notifications' : 'Unmute notifications'">
                        <svg x-show="soundEnabled" class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <svg x-show="!soundEnabled" class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
                        </svg>
                    </button>
                    <button x-show="notifications.length > 0"
                            @click="clearAll()"
                            class="text-xs text-gray-400 hover:text-gray-100 transition-colors duration-200">
                        Clear all
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification List -->
        <div class="max-h-[calc(100vh-200px)] overflow-y-auto">
            <template x-if="notifications.length === 0">
                <div class="px-2 py-4 text-sm text-gray-400">
              
                    <p>No new notifications</p>
                </div>
            </template>

            <template x-for="(notification, index) in notifications" :key="notification.timestamp">
                <div class="relative group">
                    <div @click="handleNotificationClick(index)"
                         class="block px-4 py-2 text-sm text-gray-100 hover:bg-gray-700 cursor-pointer">
                        <div class="flex justify-between items-start space-x-2">
                            <p class="font-medium flex-grow" x-text="notification.message"></p>
                            <span class="shrink-0 px-1.5 py-0.5 text-xs font-medium text-blue-200 bg-blue-900 rounded-full">New</span>
                        </div>
                        <div class="mt-0.5 flex items-center text-xs text-gray-400">
                            <span class="font-medium" x-text="notification.workflow_name"></span>
                            <span class="mx-1">•</span>
                            <span x-text="formatTimestamp(notification.timestamp)"></span>
                        </div>
                    </div>
                    
                    <!-- Delete Button -->
                    <button @click.stop="removeNotification(index)"
                            class="absolute top-2 right-2 p-1 text-gray-500 hover:text-gray-300 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-200">
                        <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </template>
        </div>
    </div>
</div>
                <div class="my-4 border-t border-gray-600"></div>
                {% endif %}

                {% if not request.user.is_authenticated %}
                <a href="{% url 'account_login' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'account_login' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Login
                </a>

                <a href="{% url 'account_signup' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'account_signup' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>
                    Sign Up
                </a>
                {% else %}
                <a href="{% url 'account_change_password' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'account_change_password' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                    Change Password
                </a>

                <a href="{% url 'account_logout' %}" class="flex items-center px-4 py-2 text-gray-100 {% if request.resolver_match.url_name == 'account_logout' %}bg-gray-700{% endif %} hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </a>
                {% endif %}
            </nav>
        </div>
    </div>

    <div x-show="sidebarOpen" 
     @click="sidebarOpen = false" 
     class="fixed inset-0 z-20 bg-black bg-opacity-50 transition-opacity md:hidden">
</div>
<!-- Main content wrapper -->
<div class="flex-1 flex flex-col w-full min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg z-10 relative">
    <div class="flex justify-between items-center px-4 py-4">
      <div class="flex items-center">
        <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 focus:outline-none lg:hidden">
          <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <h1 class="text-2xl font-semibold text-gray-900 ml-2">{{ page_title|default:"SmartFlow" }}</h1>
      </div>
      {% if request.user.is_authenticated %}
      <div class="flex items-center space-x-4">
        <div class="flex items-center text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          <span class="font-medium">{{ user.username }}</span>
        </div>
        {% if user_bu_groups %}
        <div class="flex items-center text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          <span class="font-medium">{{ user_bu_groups }}</span>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </header>

  <!-- Main content -->
  <main class="flex-1 overflow-y-auto bg-gray-100 p-4" id="content-div" hx-history-elt>
      <div class="">
        {% block content %}{% endblock content %}
      </div>
  </main>
</div>
    
</div>
  

  {% block javascript %}
  <script src="{% static 'dist/bundle.js' %}"></script>
  {% endblock javascript %}

</body>

</html>