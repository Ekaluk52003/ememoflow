{% extends "_base.html" %}
{% load crispy_forms_tags %}


{% block title %}Resubmit Document{% endblock %}

{% block content %}
<h1 class="mb-4">Resubmit Document</h1>
<form method="post">
    {% csrf_token %}
    {{ form.title|as_crispy_field }}


    <div class="mb-3">
        <label for="editor" class="form-label">Content:</label>
        <div id="editor" style="height: 300px;"></div>
    </div>
    {{ form.content }}


    {% for field in dynamic_fields %}
    <div>
        <label for="dynamic_{{ field.id }}">{{ field.name }}:</label>
        {% if field.field_type == 'text' %}
            <input type="text" id="dynamic_{{ field.id }}" name="dynamic_{{ field.id }}"
                   {% if field.required %}required{% endif %} value="{{ field.existing_value }}">
        {% elif field.field_type == 'number' %}
            <input type="number" id="dynamic_{{ field.id }}" name="dynamic_{{ field.id }}"
                   {% if field.required %}required{% endif %} value="{{ field.existing_value }}">
        {% elif field.field_type == 'date' %}
            <input type="date" id="dynamic_{{ field.id }}" name="dynamic_{{ field.id }}"
                   {% if field.required %}required{% endif %} value="{{ field.existing_value }}">
        {% elif field.field_type == 'boolean' %}
            <input type="checkbox" id="dynamic_{{ field.id }}" name="dynamic_{{ field.id }}"
                   {% if field.required %}required{% endif %} {% if field.existing_value %}checked{% endif %}>
        {% elif field.field_type == 'choice' %}
            <select id="dynamic_{{ field.id }}" name="dynamic_{{ field.id }}" {% if field.required %}required{% endif %}>
                <option value="">Select an option</option>
                {% for choice in field.choice_list %}
                    <option value="{{ choice }}" {% if choice == field.existing_value %}selected{% endif %}>{{ choice }}</option>
                {% endfor %}
            </select>
        {% endif %}
    </div>
    {% endfor %}


    {% if workflow.allow_custom_approvers %}

    {% for step in workflow.steps.all %}
    <div class="mb-3">
        <label for="approver_{{ step.id }}" class="form-label">Approver for {{ step.name }}</label>
        <select class="form-select" id="approver_{{ step.id }}" name="approver_{{ step.id }}" required>
            <option value="">Select an approver</option>
            {% for approver in potential_approvers %}
            <option value="{{ approver.id }}">{{ approver.username }}</option>
            {% endfor %}
        </select>
    </div>
    {% endfor %}
    {% endif %}
    <button type="submit" class="btn btn-primary">Resubmit Document</button>
</form>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script src="https://unpkg.com/quill-image-resize-module@3.0.0/image-resize.min.js"></script>





<!-- Add this line to safely embed the document content -->
{{ document.content|json_script:"document-content" }}

<!-- Initialize Quill editor -->
<script>



            Quill.register('modules/imageResize', ImageResize.default);

            var quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: [
                            ['bold', 'italic', 'underline', 'strike'],
                            ['blockquote', 'code-block'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],
                            [{ 'indent': '-1'}, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'font': [] }],
                            [{ 'align': [] }],
                            ['clean'],
                            ['image'], // Add image button here
                            ['undo', 'redo']  // Add undo and redo buttons here
                        ],
                        handlers: {
                            'undo': function() {
                                this.quill.history.undo();
                            },
                            'redo': function() {
                                this.quill.history.redo();
                            },
                            'image': function() {
                                var range = this.quill.getSelection();
                                var value = prompt('Please enter the image URL:');
                                if (value) {
                                    this.quill.insertEmbed(range.index, 'image', value, Quill.sources.USER);
                                }
                            }
                        }
                    },
                    history: {  // Enable the history module
                        delay: 2000,
                        maxStack: 500,
                        userOnly: true
                    },
                    imageResize: {
                        modules: [ 'Resize', 'DisplaySize', 'Toolbar' ]
                      } // Enable the image resize module
                }
            });

  // Populate the editor with existing content when resubmitting

  var documentContent = JSON.parse(document.getElementById('document-content').textContent);

  quill.root.innerHTML = documentContent;


  // When the form is submitted, update the hidden input with the editor contents
  document.querySelector('form').onsubmit = function() {
    document.querySelector('#id_content').value = quill.root.innerHTML;
  };
</script>

{% endblock %}