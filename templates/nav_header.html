  {% load static %}
{% load i18n %}

<!-- Left: Title & Mobile Toggle -->
<div class="flex items-center gap-4">
    <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 dark:text-gray-400 focus:outline-none md:hidden hover:text-neon-violet transition-colors">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>
    
    <!-- Mobile Brand -->
    <a href="{% url 'home' %}" class="flex items-center gap-2 md:hidden">
        <div class="w-8 h-8 bg-neon-violet/10 rounded-lg border border-neon-violet/50 flex items-center justify-center">
            <i data-lucide="zap" class="w-5 h-5 text-neon-violet"></i>
        </div>
        <span class="text-lg font-bold text-gray-900 dark:text-white">SmartFlow</span>
    </a>
</div>

<!-- Right: Actions -->
<div class="flex items-center gap-4" 
     x-data="{
        isOpen: false,
        notifications: [],
        notificationCount: 0,
        ws: null,
        connectionStatus: 'disconnected',
        soundEnabled: localStorage.getItem('soundEnabled') !== 'false',
        notificationSound: null,

        getCsrfToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            return token || '';
        },

        init() {
            const NOTIFICATION_SOUND_URL = '{% static 'sounds/notification.mp3' %}';
            this.notificationSound = new Audio(NOTIFICATION_SOUND_URL);
            this.connectWebSocket();
            this.loadNotifications();
        },

        getConnectionStatusText() {
            if (this.connectionStatus === 'disconnected') return 'Reconnecting...';
            if (this.connectionStatus === 'error') return 'Connection Error';
            return 'connected';
        },

        loadNotifications() {
            fetch('{% url 'document_approval:load_notifications' %}')
                .then(response => response.json())
                .then(data => {
                    this.notifications = data.notifications;
                    this.notificationCount = data.unread_count;
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    this.notifications = [];
                    this.notificationCount = 0;
                });
        },

        deleteNotification(notificationId, index) {
            const token = this.getCsrfToken();
            if (!token) return;

            fetch(`{% url 'document_approval:delete_notification' notification_id=0 %}`.replace('0', notificationId), {
                method: 'POST',
                headers: { 'X-CSRFToken': token }
            })
            .then(response => response.json())
            .then(data => {
                this.notifications.splice(index, 1);
                this.notificationCount = data.unread_count;
            });
        },

        clearAllNotifications() {
            const token = this.getCsrfToken();
            if (!token) return;

            fetch('{% url 'document_approval:clear_all_notifications' %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': token }
            })
            .then(response => response.json())
            .then(data => {
                this.notifications = [];
                this.notificationCount = 0;
            });
        },

        markNotificationRead(notificationId) {
            const token = this.getCsrfToken();
            if (!token) return;

            fetch(`{% url 'document_approval:mark_notification_read' notification_id=0 %}`.replace('0', notificationId), {
                method: 'POST',
                headers: { 'X-CSRFToken': token }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.notifications.forEach((n, index) => {
                        if (n.id === notificationId) {
                            this.notifications[index].is_read = true;
                        }
                    });
                    this.notificationCount = data.unread_count;
                }
            });
        },

        handleNotificationClick(index) {
            const notification = this.notifications[index];
            if (notification && notification.url) {
                this.markNotificationRead(notification.id);
                window.location.href = notification.url;
            }
        },

        connectWebSocket() {
            const userId = '{{ request.user.id }}';
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const isDevelopment = window.location.port === '8000';
            const wsUrl = isDevelopment 
            ? `${wsProtocol}//127.0.0.1:8001/ws/${userId}`
            : `${wsProtocol}//${window.location.host}/ws/${userId}`;

            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                this.connectionStatus = 'connected';
                this.loadNotifications();
            };

            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'notification') {
                    const notification = data.notification;
                    if (!this.notifications.some(n => n.id === notification.id)) {
                        this.notifications.unshift(notification);
                        if (this.notifications.length > 50) this.notifications = this.notifications.slice(0, 50);
                        this.notificationCount += 1;
                        if (this.soundEnabled && this.notificationSound) {
                            this.notificationSound.currentTime = 0;
                            this.notificationSound.play().catch(() => {});
                        }
                    }
                }
            };

            this.ws.onclose = () => {
                this.connectionStatus = 'disconnected';
                setTimeout(() => {
                    if (document.visibilityState === 'visible') {
                        this.connectWebSocket();
                    }
                }, 5000);
            };

            this.ws.onerror = () => {
                this.connectionStatus = 'error';
            };
        },

        toggleSound() {
            this.soundEnabled = !this.soundEnabled;
            localStorage.setItem('soundEnabled', this.soundEnabled);
        }
    }">

    <!-- Theme Toggle -->
    <button id="theme-toggle" class="p-2 text-gray-500 dark:text-gray-400 hover:text-neon-violet dark:hover:text-white transition-colors rounded-full hover:bg-white/10" onclick="toggleTheme()">
        <i id="theme-icon-moon" data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
        <i id="theme-icon-sun" data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
    </button>
    
    <div class="h-4 w-[1px] bg-gray-300 dark:bg-white/10"></div>

    <!-- Notification Bell -->
    <div class="relative">
        <button @click="isOpen = !isOpen" class="relative p-2 text-gray-500 dark:text-gray-400 hover:text-neon-violet transition-colors">
            <i data-lucide="bell" class="w-5 h-5" :class="{'text-neon-violet': isOpen}"></i>
            <template x-if="notificationCount > 0">
                <span class="absolute top-2 right-2 w-2 h-2 bg-neon-violet rounded-full shadow-[0_0_5px_#8b5cf6] animate-pulse"></span>
            </template>
        </button>

        <!-- Notification Dropdown -->
        <div x-show="isOpen" 
             x-cloak
             @click.away="isOpen = false"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 translate-y-2"
             class="absolute right-0 mt-2 w-80 md:w-96 bg-white dark:bg-[#0f0f0f] rounded-xl shadow-[0_0_30px_rgba(0,0,0,0.5)] border border-gray-200 dark:border-white/10 overflow-hidden z-50 backdrop-blur-md">
            
            <!-- Header -->
            <div class="px-4 py-3 border-b border-gray-200 dark:border-white/10 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Notifications</h3>
                <div class="flex items-center gap-2">
                    <button @click="toggleSound()" class="text-gray-400 hover:text-neon-violet transition-colors">
                        <i data-lucide="volume-2" class="w-4 h-4" x-show="soundEnabled"></i>
                        <i data-lucide="volume-x" class="w-4 h-4" x-show="!soundEnabled"></i>
                    </button>
                    <button @click="clearAllNotifications()" x-show="notifications.length > 0" class="text-xs text-gray-500 hover:text-red-500 transition-colors">Clear all</button>
                </div>
            </div>

            <!-- List -->
            <div class="max-h-[400px] overflow-y-auto custom-scrollbar">
                <template x-if="notifications.length === 0">
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                        <i data-lucide="bell-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                        <p class="text-sm">No new notifications</p>
                    </div>
                </template>

                <template x-for="(notification, index) in notifications" :key="notification.id">
                    <div class="p-4 border-b border-gray-100 dark:border-white/5 hover:bg-gray-50 dark:hover:bg-white/5 transition-colors cursor-pointer group relative"
                         :class="{ 'bg-neon-violet/5': !notification.is_read }"
                         @click="handleNotificationClick(index)">
                        <div class="flex gap-3">
                            <div class="flex-shrink-0 mt-1">
                                <div class="w-2 h-2 rounded-full" :class="notification.is_read ? 'bg-gray-300 dark:bg-gray-700' : 'bg-neon-violet shadow-[0_0_5px_#8b5cf6]'"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white mb-0.5" x-text="notification.workflow_name"></p>
                                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-1.5" x-text="notification.message"></p>
                                <p class="text-xs text-gray-400 dark:text-gray-500" x-text="new Date(notification.timestamp).toLocaleString()"></p>
                            </div>
                            <button @click.stop="deleteNotification(notification.id, index)" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Footer status -->
            <div class="px-4 py-2 bg-gray-50 dark:bg-white/5 border-t border-gray-200 dark:border-white/10 text-center">
                <span class="text-[10px] font-mono text-gray-400" x-text="'Status: ' + getConnectionStatusText()"></span>
            </div>
        </div>
    </div>

    <!-- New Request Button -->
    <div x-data="{ isOpen: false }" class="relative hidden md:block">
        <button @click="isOpen = !isOpen" class="px-4 py-1.5 bg-neon-violet hover:bg-neon-purple text-white text-sm font-medium rounded-full shadow-[0_0_15px_rgba(255, 95, 31,0.4)] hover:shadow-[0_0_20px_rgba(255, 95, 31,0.6)] transition-all flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>New Request</span>
        </button>

        <!-- Workflows Dropdown -->
        <div x-show="isOpen" 
             x-cloak
             @click.away="isOpen = false"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             class="absolute right-0 mt-2 w-56 bg-white dark:bg-[#0f0f0f] rounded-xl shadow-xl border border-gray-200 dark:border-white/10 overflow-hidden z-50">
            <div class="py-1">
                {% for workflow in workflows %}
                <a href="{% url 'document_approval:submit_document' workflow.id %}" class="flex items-center px-4 py-2.5 text-sm text-gray-700 dark:text-gray-300 hover:bg-neon-violet/10 hover:text-neon-violet transition-colors">
                    <i data-lucide="file-text" class="w-4 h-4 mr-2 opacity-70"></i>
                    {{ workflow.name }}
                </a>
                {% empty %}
                <div class="px-4 py-2 text-sm text-gray-500">No workflows available</div>
                {% endfor %}
            </div>
        </div>
    </div>

{% csrf_token %}